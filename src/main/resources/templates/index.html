<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Phishing Campaign Simulator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            padding: 2rem;
            background: #f8f9fa;
            color: #22223b;
        }
        /* Header */
        .main-header {
            background: linear-gradient(90deg, #0056b3 60%, #00b4d8 100%);
            border-radius: 1rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .main-header h2 {
            color: #fff;
            font-weight: 700;
            letter-spacing: 1px;
            margin: 0;
        }
        .main-header img {
            height: 48px;
            margin-right: 1rem;
        }
        /* Tabs */
        .nav-tabs .nav-link.active {
            background: #0056b3;
            color: #fff !important;
            border-color: #0056b3 #0056b3 #fff;
            font-weight: 600;
        }
        .nav-tabs .nav-link {
            color: #0056b3;
            font-weight: 500;
            border-radius: 0.5rem 0.5rem 0 0;
            margin-right: 2px;
            transition: background 0.2s, color 0.2s;
        }
        .nav-tabs .nav-link:hover {
            background: #e3f2fd;
            color: #003366;
        }
        /* Cards */
        .card {
            border-radius: 1rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            border: none;
        }
        .card .card-title {
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        /* Dashboard Cards */
        .dashboard-card.bg-primary {
            background: linear-gradient(135deg, #0056b3 70%, #00b4d8 100%);
        }
        .dashboard-card.bg-warning {
            background: linear-gradient(135deg, #ffd166 70%, #ffe699 100%);
            color: #22223b !important;
        }
        .dashboard-card.bg-danger {
            background: linear-gradient(135deg, #ef476f 70%, #ffd166 100%);
        }
        /* Table Styles */
        .table {
            background: #fff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .table th, .table td {
            border: none !important;
            vertical-align: middle;
        }
        .table tr {
            transition: background 0.2s;
        }
        .table tr:hover {
            background: #e3f2fd;
        }
        .table thead th {
            background: #0056b3;
            color: #fff;
            font-weight: 600;
            border-bottom: 2px solid #00b4d8 !important;
        }
        .table.borderless th, .table.borderless td {
            border: none !important;
        }
        /* Form Labels */
        label.form-label, label { font-weight: bold; }
        /* Editors & Previews */
        #templateContent, #landingContent {
            min-height: 400px;
            height: 400px;
            resize: vertical;
        }
        #templatePreview, #landingPreview {
            min-height: 400px;
            height: 400px;
            background: #fafafa;
            border: 1px solid #ccc;
            padding: 1rem;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <div class="d-flex align-items-center">
                <h2>Phishing Campaign Simulator</h2>
            </div>
            <a href="/logout" class="btn btn-outline-light">Logout</a>
        </header>
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="campaign-tab" data-bs-toggle="tab" data-bs-target="#campaign" type="button" role="tab">Campaign</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template" type="button" role="tab">Email Template</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="landing-tab" data-bs-toggle="tab" data-bs-target="#landing" type="button" role="tab">Landing Page</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users & Groups</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="eml-tab" data-bs-toggle="tab" data-bs-target="#eml" type="button" role="tab">EML Upload</button>
            </li>
        </ul>
        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card dashboard-card bg-primary text-white mb-3 shadow-sm">
                            <div class="card-body text-center">
                                <i class="bi bi-bar-chart-fill" style="font-size:2.5rem;"></i>
                                <h5 class="card-title mt-2">Campaigns</h5>
                                <span class="display-5 fw-bold" id="dashboardCampaignCount">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card dashboard-card bg-warning text-dark mb-3 shadow-sm">
                            <div class="card-body text-center">
                                <i class="bi bi-envelope-fill" style="font-size:2.5rem;"></i>
                                <h5 class="card-title mt-2">Email Templates</h5>
                                <span class="display-5 fw-bold" id="dashboardTemplateCount">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card dashboard-card bg-danger text-white mb-3 shadow-sm">
                            <div class="card-body text-center">
                                <i class="bi bi-globe2" style="font-size:2.5rem;"></i>
                                <h5 class="card-title mt-2">Landing Pages</h5>
                                <span class="display-5 fw-bold" id="dashboardLandingPageCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-info mb-2" id="dashboardAIInsightsBtn">Get AI Insights</button>
                <div id="dashboardAIInsights" class="alert alert-secondary" style="display:none;"></div>
            </div>
            <div class="tab-pane fade" id="campaign" role="tabpanel">
                <h4>Campaign</h4>
                <form id="campaignForm" onsubmit="event.preventDefault();">
                    <div class="mb-3">
                        <label for="campaignName" class="form-label">Campaign Name</label>
                        <input type="text" class="form-control" id="campaignName" placeholder="Enter campaign name" autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label for="campaignDesc" class="form-label">Description</label>
                        <textarea class="form-control" id="campaignDesc" rows="2" placeholder="Enter campaign description" autocomplete="off"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="targetUsers" class="form-label">Target Users (comma separated emails)</label>
                        <input type="text" class="form-control" id="targetUsers" placeholder="user1@example.com, user2@example.com" autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label for="campaignEmailTemplate" class="form-label">Email Template</label>
                        <select class="form-select" id="campaignEmailTemplate">
                            <option value="">-- Select Email Template --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="campaignLandingPage" class="form-label">Landing Page</label>
                        <select class="form-select" id="campaignLandingPage">
                            <option value="">-- Select Landing Page --</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" id="createCampaignBtn">Create Campaign</button>
                </form>
            </div>
            <div class="tab-pane fade" id="template" role="tabpanel">
                <h4>Email Template</h4>
                <form onsubmit="event.preventDefault();">
                    <div class="mb-3">
                        <label for="templateSelect" class="form-label">Select Email Template</label>
                        <select class="form-select mb-3" id="templateSelect" onchange="loadEmailTemplate()">
                            <option value="">-- Select --</option>
                            <option value="1">Welcome Email</option>
                            <option value="2">Security Alert</option>
                            <option value="3">Special Offer</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="templateAIQuery" class="form-label">NLP Query to AI</label>
                        <input type="text" class="form-control" id="templateAIQuery" placeholder="Ask AI to generate subject or body..." autocomplete="off">
                        <button type="button" class="btn btn-primary mt-2" id="templateAIFetchBtn">Fetch from AI</button>
                        <div class="radio-group mt-2">
                            <label><input type="radio" name="templateAIOutput" value="subject" checked> Populate Subject</label>
                            <label class="ms-3"><input type="radio" name="templateAIOutput" value="body"> Populate Body</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="templateName" placeholder="Enter template name" autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label for="templateSubject" class="form-label">Email Subject</label>
                        <textarea class="form-control" id="templateSubject" rows="1" maxlength="80" style="height:2.5em;resize:none;" placeholder="Max 10 words..." autocomplete="off"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="templateLandingPage" class="form-label">Select Landing Page</label>
                        <select class="form-select" id="templateLandingPage">
                            <option value="">-- Select Landing Page --</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table borderless align-middle">
                                <tr>
                                    <td style="width:50%; vertical-align:top;">
                                        <label for="templateContent" class="form-label">Email HTML Editor</label>
                                        <textarea class="form-control" id="templateContent" rows="10" placeholder="Email body..." autocomplete="off"></textarea>
                                    </td>
                                    <td style="width:50%; vertical-align:top;">
                                        <label class="form-label">Live Preview</label>
                                        <div id="templatePreview" style="border:1px solid #ccc; min-height:200px; padding:1rem; background:#fafafa;"></div>
                                    </td>
                                </tr>
                            </table>
                            <table class="table borderless mt-2">
                                <tr>
                                    <td class="text-center">
                                        <button type="submit" class="btn btn-success" style="min-width:120px;" id="saveTemplateBtn">Save</button>
                                        <button type="button" class="btn btn-danger ms-2" style="min-width:100px;" id="deleteTemplateBtn">Delete</button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <div class="tab-pane fade" id="landing" role="tabpanel">
                <h4>Landing Page</h4>
                <form onsubmit="event.preventDefault();">
                    <div class="mb-3">
                        <label for="landingSelect" class="form-label">Select Landing Page</label>
                        <select class="form-select mb-3" id="landingSelect" onchange="loadLandingPage()">
                            <option value="">-- Select --</option>
                            <option value="1">Landing Page 1</option>
                            <option value="2">Landing Page 2</option>
                            <option value="3">Landing Page 3</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="landingAIQuery" class="form-label">NLP Query to AI</label>
                        <input type="text" class="form-control" id="landingAIQuery" placeholder="Ask AI to generate landing page HTML..." autocomplete="off">
                        <button type="button" class="btn btn-primary mt-2" id="landingAIFetchBtn">Fetch from AI</button>
                    </div>
                    <div class="mb-3">
                        <label for="landingName" class="form-label">Landing Page Name</label>
                        <input type="text" class="form-control" id="landingName" placeholder="Enter landing page name" autocomplete="off">
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table borderless align-middle">
                                <tr>
                                    <td style="width:50%; vertical-align:top;">
                                        <label for="landingContent" class="form-label">Landing Page HTML Editor</label>
                                        <textarea class="form-control" id="landingContent" rows="10" placeholder="HTML or text for landing page..." autocomplete="off"></textarea>
                                    </td>
                                    <td style="width:50%; vertical-align:top;">
                                        <label class="form-label">Live Preview</label>
                                        <div id="landingPreview" style="border:1px solid #ccc; min-height:200px; padding:1rem; background:#fafafa;"></div>
                                    </td>
                                </tr>
                            </table>
                            <table class="table borderless mt-2">
                                <tr>
                                    <td class="text-center">
                                        <button type="submit" class="btn btn-info" style="min-width:120px;" id="saveLandingBtn">Save</button>
                                        <button type="button" class="btn btn-danger ms-2" style="min-width:100px;" id="deleteLandingBtn">Delete</button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <div class="tab-pane fade" id="users" role="tabpanel">
                <h4>Users & Groups</h4>
                <form>
                    <div class="mb-3">
                        <label for="userEmails" class="form-label">Add Users (comma separated emails)</label>
                        <input type="text" class="form-control" id="userEmails" placeholder="user1@example.com, user2@example.com" autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="groupName" placeholder="Enter group name" autocomplete="off">
                    </div>
                    <button type="submit" class="btn btn-secondary">Add Group</button>
                </form>
                <p class="mt-3">List of users and groups will appear here.</p>
            </div>
            <div class="tab-pane fade" id="eml" role="tabpanel">
                <h4>Upload .eml File</h4>
                <form id="emlUploadForm" enctype="multipart/form-data" onsubmit="event.preventDefault(); uploadEmlFile();">
                    <div class="mb-3">
                        <input type="file" class="form-control" id="emlFile" accept=".eml" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload & Extract HTML</button>
                </form>
                <div id="emlLoading" class="text-info mb-2" style="display:none;">
                    <div class="spinner-border spinner-border-sm" role="status"></div> Extracting HTML...
                </div>
                <div class="mt-4">
                    <label class="form-label">Extracted HTML Content:</label>
                    <table class="table borderless align-middle">
                        <tr>
                            <td style="width:50%; vertical-align:top;">
                                <label class="form-label">Preview</label>
                                <div id="emlHtmlPreview" style="border:1px solid #ccc; min-height:200px; padding:1rem; background:#fafafa; overflow:auto;"></div>
                            </td>
                            <td style="width:50%; vertical-align:top;">
                                <label class="form-label">HTML Code</label>
                                <textarea id="emlHtmlCode" class="form-control" style="background: rgb(245, 245, 245); font-family: monospace; overflow: auto; resize: vertical; height: 1030px;" readonly=""></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ...existing JavaScript code remains unchanged... -->
    <script>
        const SAGE_API_BEARER = "eyJ0eXAiOiJKV1QiLCJhbGciOiJQUzI1NiJ9.eyJpc3MiOiJkZXZlbG9wZXIiLCJraWQiOiIxIiwiaWF0IjoxNzU0NTQ3MzYwLjIzMTIxNSwibmJmIjoxNzU0NTQ3MzYzLjIzMTIxNSwiZXhwIjoxNzU0ODA2NTYzLjIzMTIxNSwicHJlZmVycmVkX3VzZXJuYW1lIjoibmFtQGJhcnJhY3VkYS5jb20iLCJuYW1lIjoiTmFuZGhpbmkgTSIsInNlc3Npb25fdG9rZW4iOiJjY2Q1NGIxNC1lYjE5LTQ3MmUtYWMwYy0xZDFhZWM4ZmU0MjQifQ.VPCrTbZfRk4adIrPWa9tgSLeK-3lb5i8HNcjvnaiK4luy0oFAWb3KorHTFH83WKCRfafm87L8P6fK8LXC_T0FCQ09WI-TT6uWIe7vBwVcXlLFuE0p2jxpHLl7Hd185AOikQrt_3pj4NPOk986kE_cxFWMBVXJtW8T0l2A1BUjNuQzsynD8LV67Z6EZ5pJIwLd-E2tFe46QgAX73z6rOZgM5zHyBuEQj8fqHlhugjDBVmyosoY1jJ2W4a4I3xPK-TRgor_Jy6nECewRcB3GQ-ZuWYffdr9EamcU3plWRfFD7An8F4exdu8sG_KtyVn1O03jT3Da2PHJm1ZWNCJeuQdeTqsIJiZvg58ttFUMMM89lA7m3PDOCx1hSCdYb9mT0jtwtV3nHZOiPlh9afLalbCKDdiz010AE6oIt04C-ZIHHd1PNjZUHq3dpsVlQsIlZj3i9kRIkLGNRqnNQCbTZty46B7CAvh9tnmdaiip8_OF-Emes6wZYfTMZ7Qc7V6lWuRth9i-8C_PcN8OETBLUanxY-6hD4QiO2aNZqzBuOVO6iERP9_fG9APFHJkIicB2U4abBh5cxKaM9GD1PqY_BJNa-S4qceD7C0fEj8lRssw0Z057hX8jxo9AsyHzUc7BsqaQOtTOICjkTCO-DqXKZeD0QvpQpF-YOFbMDd5UMUrw";
        // --- Raw HTML Editor Initialization ---
        let quill = null, landingQuill = null;
        document.addEventListener('DOMContentLoaded', function() {
            // Remove Quill, use textarea for raw HTML input
            var quillEditorDiv = document.getElementById('quillEditor');
            if (quillEditorDiv) quillEditorDiv.parentNode.removeChild(quillEditorDiv);
            document.getElementById('templateContent').classList.remove('d-none');
            var landingQuillEditorDiv = document.getElementById('landingQuillEditor');
            if (landingQuillEditorDiv) landingQuillEditorDiv.parentNode.removeChild(landingQuillEditorDiv);
            document.getElementById('landingContent').classList.remove('d-none');
            // Live preview for raw HTML
            document.getElementById('templateContent').addEventListener('input', renderTemplatePreview);
            document.getElementById('landingContent').addEventListener('input', renderLandingPreview);
            // Initial preview render in case textarea has value
            renderTemplatePreview();
            renderLandingPreview();
        });
        // --- Live Preview Functions ---
        function renderTemplatePreview() {
            const html = document.getElementById('templateContent').value;
            document.getElementById('templatePreview').innerHTML = html;
        }
        function renderLandingPreview() {
            const html = document.getElementById('landingContent').value;
            document.getElementById('landingPreview').innerHTML = html;
        }
        // --- Email Template CRUD ---
        let emailTemplates = {};
        function fetchEmailTemplates() {
            fetch('/api/email-templates')
                .then(res => res.json())
                .then(data => {
                    emailTemplates = {};
                    const select = document.getElementById('templateSelect');
                    select.innerHTML = '<option value="">-- Select --</option>';
                    data.forEach(t => {
                        emailTemplates[t.id] = t;
                        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                    });
                });
        }
        function loadEmailTemplate() {
            var id = document.getElementById('templateSelect').value;
            if (emailTemplates[id]) {
                document.getElementById('templateName').value = emailTemplates[id].name;
                document.getElementById('templateContent').value = emailTemplates[id].htmlContent;
                renderTemplatePreview();
            } else {
                document.getElementById('templateName').value = "";
                document.getElementById('templateContent').value = "";
                document.getElementById('templatePreview').innerHTML = "";
            }
        }
        document.querySelector('#template-tab').addEventListener('click', fetchEmailTemplates);
        document.querySelector('#templateSelect').addEventListener('change', loadEmailTemplate);
        document.querySelector('#templateName').addEventListener('input', () => {
            document.getElementById('templateName').value = document.getElementById('templateName').value;
        });
        document.querySelector('#template-tab').addEventListener('click', renderTemplatePreview);
        document.querySelector('#template-tab').addEventListener('click', () => {
            document.getElementById('templateName').value = "";
            document.getElementById('templateContent').value = "";
            document.getElementById('templatePreview').innerHTML = "";
        });
        document.querySelector('#template-tab').addEventListener('click', () => {
            document.querySelector('form[onsubmit="event.preventDefault();"] .btn-success').onclick = function() {
                const id = document.getElementById('templateSelect').value;
                const dto = {
                    name: document.getElementById('templateName').value,
                    htmlContent: document.getElementById('templateContent').value,
                    subject: document.getElementById('templateSubject').value
                };
                if (!dto.name) {
                    alert('Email Template Name is required!');
                    return;
                }
                if (id) {
                    fetch(`/api/email-templates/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dto)
                    }).then(() => { alert('Template updated!'); fetchEmailTemplates(); });
                } else {
                    fetch('/api/email-templates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dto)
                    }).then(() => { alert('Template saved!'); fetchEmailTemplates(); });
                }
            };
        });
        // Remove previous dynamic button creation for deleteTemplateBtn and update event listeners to use the new static button ids
        document.querySelector('#template-tab').addEventListener('click', () => {
            document.getElementById('deleteTemplateBtn').onclick = function() {
                const id = document.getElementById('templateSelect').value;
                if (id) {
                    if (confirm('Are you sure you want to delete this template?')) {
                        fetch(`/api/email-templates/${id}`, { method: 'DELETE' })
                            .then(() => { alert('Template deleted!'); fetchEmailTemplates(); loadEmailTemplate(); });
                    }
                } else {
                    alert('Select a template to delete.');
                }
            };
            // Ensure preview works after Quill is initialized
            renderTemplatePreview();
        });
        // --- Landing Page CRUD ---
        let landingPages = {};
        function fetchLandingPages() {
            fetch('/api/landing-pages')
                .then(res => res.json())
                .then(data => {
                    landingPages = {};
                    const select = document.getElementById('landingSelect');
                    select.innerHTML = '<option value="">-- Select --</option>';
                    data.forEach(p => {
                        landingPages[p.id] = p;
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                });
        }
        function loadLandingPage() {
            var id = document.getElementById('landingSelect').value;
            if (landingPages[id]) {
                document.getElementById('landingName').value = landingPages[id].name;
                document.getElementById('landingContent').value = landingPages[id].htmlContent;
                renderLandingPreview();
            } else {
                document.getElementById('landingName').value = "";
                document.getElementById('landingContent').value = "";
                document.getElementById('landingPreview').innerHTML = "";
            }
        }
        document.querySelector('#landing-tab').addEventListener('click', fetchLandingPages);
        document.querySelector('#landingSelect').addEventListener('change', loadLandingPage);
        document.querySelector('#landingName').addEventListener('input', () => {
            document.getElementById('landingName').value = document.getElementById('landingName').value;
        });
        document.querySelector('#landing-tab').addEventListener('click', renderLandingPreview);
        document.querySelector('#landing-tab').addEventListener('click', () => {
            document.getElementById('landingName').value = "";
            document.getElementById('landingContent').value = "";
            document.getElementById('landingPreview').innerHTML = "";
        });
        document.querySelector('#landing-tab').addEventListener('click', () => {
            document.querySelector('form[onsubmit="event.preventDefault();"] .btn-info').onclick = function() {
                const id = document.getElementById('landingSelect').value;
                const dto = {
                    name: document.getElementById('landingName').value,
                    htmlContent: document.getElementById('landingContent').value
                };
                if (!dto.name || !dto.htmlContent) {
                    alert('Landing Page Name and HTML Content are required!');
                    return;
                }
                if (id) {
                    fetch(`/api/landing-pages/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dto)
                    }).then(() => { alert('Landing page updated!'); fetchLandingPages(); });
                } else {
                    fetch('/api/landing-pages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dto)
                    }).then(() => { alert('Landing page saved!'); fetchLandingPages(); });
                }
            };
        });
        // Add delete buttons and logic for Landing Page
        document.querySelector('#landing-tab').addEventListener('click', () => {
            let deleteBtn = document.getElementById('deleteLandingBtn');
            if (!deleteBtn) {
                deleteBtn = document.createElement('button');
                deleteBtn.id = 'deleteLandingBtn';
                deleteBtn.className = 'btn btn-danger mt-2';
                deleteBtn.textContent = 'Delete Landing Page';
                // Fix selector: use form tag, not .form class
                document.querySelector('#landing form').appendChild(deleteBtn);
            }
            deleteBtn.onclick = function() {
                const id = document.getElementById('landingSelect').value;
                if (id) {
                    if (confirm('Are you sure you want to delete this landing page?')) {
                        fetch(`/api/landing-pages/${id}`, { method: 'DELETE' })
                            .then(() => { alert('Landing page deleted!'); fetchLandingPages(); loadLandingPage(); });
                    }
                } else {
                    alert('Select a landing page to delete.');
                }
            };
            // Ensure preview works after Quill is initialized
            renderLandingPreview();
        });
        // --- Populate Landing Page Dropdown in Email Template ---
        function fetchLandingPagesForTemplate() {
            fetch('/api/landing-pages')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('templateLandingPage');
                    select.innerHTML = '<option value="">-- Select Landing Page --</option>';
                    data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                });
        }
        function uploadEmlFile() {
            const fileInput = document.getElementById('emlFile');
            if (!fileInput.files.length) {
                alert('Please select a .eml file.');
                return;
            }
            document.getElementById('emlLoading').style.display = 'block';
            document.getElementById('emlHtmlPreview').innerHTML = '';
            document.getElementById('emlHtmlCode').value = '';
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            fetch('/api/eml/extract-html', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('emlHtmlPreview').innerHTML = data.htmlContent || '<em>No HTML content found.</em>';
                document.getElementById('emlHtmlCode').value = data.htmlContent || '';
            })
            .catch(err => {
                alert('Failed to extract HTML: ' + err);
            })
            .finally(() => {
                document.getElementById('emlLoading').style.display = 'none';
            });
        }
        document.querySelector('#template-tab').addEventListener('click', fetchLandingPagesForTemplate);
        // --- AI Integration for Email Template ---
        document.getElementById('templateAIFetchBtn').addEventListener('click', function() {
            let userQuery = document.getElementById('templateAIQuery').value;
            const selectedTarget = document.querySelector('input[name="templateAIOutput"]:checked').value;
            if (selectedTarget === 'body') {
                const landingPageId = document.getElementById('templateLandingPage').value;
                let landingUrl = '';
                if (landingPageId) {
                    landingUrl = `http://localhost:8080/public/landing/${landingPageId}`;
                }
                userQuery += ' api conent must only contain html content and no more messages above or below html and nor more code blocks and use the provided landing page url as value of hyperlink ';
                if (landingUrl) {
                    userQuery += ` Landing page URL: ${landingUrl}`;
                }
            } else if (selectedTarget === 'subject') {
                userQuery += ' in max two or three words';
            }
            if (!userQuery.trim()) {
                alert('Please enter a query.');
                return;
            }
            fetch('https://api.sage.cudasvc.com/openai/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + SAGE_API_BEARER,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: userQuery }],
                    model: 'gpt-4o-mini'
                })
            })
            .then(response => response.json())
            .then(data => {
                const responseContent = data.choices[0].message.content;
                if (selectedTarget === 'subject') {
                    document.getElementById('templateSubject').value = responseContent;
                } else if (selectedTarget === 'body') {
                    document.getElementById('templateContent').value = responseContent;
                    renderTemplatePreview();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        });
        document.getElementById('templateContent').addEventListener('input', renderTemplatePreview);
        document.getElementById('templateSubject').addEventListener('input', function() {
            if (this.value.split(/\s+/).length > 10) {
                this.value = this.value.split(/\s+/).slice(0,10).join(' ');
            }
        });
        // --- AI Integration for Landing Page ---
        document.getElementById('landingAIFetchBtn').addEventListener('click', function() {
            let userQuery = document.getElementById('landingAIQuery').value;
            userQuery += ', content tag must only contain html content, no additional info above and below html content and no code blocks.';
            if (!userQuery) {
                alert('Please enter a query.');
                return;
            }
            fetch('https://api.sage.cudasvc.com/openai/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + SAGE_API_BEARER,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: userQuery }],
                    model: 'gpt-4o-mini'
                })
            })
            .then(response => response.json())
            .then(data => {
                const responseContent = data.choices[0].message.content;
                document.getElementById('landingContent').value = responseContent;
                renderLandingPreview();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        });
        document.getElementById('landingContent').addEventListener('input', renderLandingPreview);
        // --- Populate Email Template Dropdown ---
        function fetchEmailTemplatesForCampaign() {
            fetch('/api/email-templates')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('campaignEmailTemplate');
                    select.innerHTML = '<option value="">-- Select Email Template --</option>';
                    data.forEach(t => {
                        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                    });
                });
        }
        document.querySelector('#campaign-tab').addEventListener('click', fetchEmailTemplatesForCampaign);
        // --- Populate Landing Page Dropdown ---
        function fetchLandingPagesForCampaign() {
            fetch('/api/landing-pages')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('campaignLandingPage');
                    select.innerHTML = '<option value="">-- Select Landing Page --</option>';
                    data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                });
        }
        document.querySelector('#campaign-tab').addEventListener('click', fetchLandingPagesForCampaign);
        // --- Save Campaign and Send Emails ---
        document.getElementById('createCampaignBtn').onclick = function() {
            const campaign = {
                name: document.getElementById('campaignName').value,
                description: document.getElementById('campaignDesc').value,
                targetUsers: document.getElementById('targetUsers').value,
                emailTemplateId: document.getElementById('campaignEmailTemplate').value,
                landingPageId: document.getElementById('campaignLandingPage').value
            };
            fetch('/api/campaigns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(campaign)
            }).then(res => res.json())
            .then(data => {
                alert('Campaign saved and emails sent!');
            });
        };
        document.getElementById('emlHtmlCode').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight + 8) + 'px';
        });
        function fetchDashboardStats() {
            fetch('/api/dashboard/stats')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('dashboardCampaignCount').innerText = data.campaignCount;
                    document.getElementById('dashboardTemplateCount').innerText = data.templateCount;
                    document.getElementById('dashboardLandingPageCount').innerText = data.landingPageCount;
                });
        }
        document.getElementById('dashboard-tab').addEventListener('click', fetchDashboardStats);

        // AI Insights Button
        document.getElementById('dashboardAIInsightsBtn').onclick = function() {
            fetch('/api/dashboard/stats')
                .then(res => res.json())
                .then(stats => {
                    // Call your AI API here, e.g., OpenAI or internal endpoint
                    return fetch('https://api.sage.cudasvc.com/openai/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + SAGE_API_BEARER,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: [{
                                content: `Analyze these phishing campaign stats and provide insights: ${JSON.stringify(stats)}`,
                                role: 'user'
                            }],
                            model: 'gpt-4o-mini'
                        })
                    });
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('dashboardAIInsights').style.display = 'block';
                    document.getElementById('dashboardAIInsights').innerText = data.choices[0].message.content;
                })
                .catch(() => {
                    document.getElementById('dashboardAIInsights').style.display = 'block';
                    document.getElementById('dashboardAIInsights').innerText = 'AI insights could not be loaded.';
                });
        };
    </script>
</body>
</html>